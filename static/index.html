<!DOCTYPE html>
<html>

<head>
    <title>GPU Dashboard</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <label for="server-select">Select Server</label>
                <select id="server-select" class="form-control">
                    <option value="all">All</option>
                    <option value="banana">Banana</option>
                    <option value="chai">Chai</option>
                    <option value="cheetah">Cheetah</option>
                    <option value="guacamole">Guacamole</option>
                    <option value="kiwi">Kiwi</option>
                    <option value="lavazza">Lavazza</option>
                    <option value="latte">Latte</option>
                    <option value="lox">Lox</option>
                    <option value="macchiato">Macchiato</option>
                    <option value="matcha">Matcha</option>
                    <!-- Add more servers here -->
                </select>
            </div>
            <div class="col-md-3">
                <label for="memory-filter">Memory Filter (<= MiB)</label>
                        <input type="number" id="memory-filter" class="form-control" placeholder="Enter Memory">
            </div>
            <div class="col-md-3">
                <label for="utilization-filter">Utilization Filter (<= %)</label>
                        <input type="number" id="utilization-filter" class="form-control"
                            placeholder="Enter Utilization">
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary mt-4" onclick="updateTable()">Filter</button>
            </div>
        </div>
    </div>

    <table id="gpu-table" class="display" style="width:100%">
        <thead>
            <tr>
                <th>Server</th>
                <th>GPU</th>
                <th>Name</th>
                <th>Temp</th>
                <th>Power</th>
                <th>Memory</th>
                <th>Utilization</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <script>
        var table = $('#gpu-table').DataTable({ searching: true });
        var servers = ['guacamole', 'lavazza', "banana", "matcha", "latte", "chai", "lox", "cheetah", "kiwi", "macchiato"];  // Add more servers here
        var lastData = {};

        function parseValue(value) {
            return parseFloat(value.split(' ')[0]);
        }

        function updateTable() {
            var selectedServer = $('#server-select').val();
            var memoryFilter = Number($('#memory-filter').val()) || Infinity;
            var utilizationFilter = Number($('#utilization-filter').val()) || Infinity;

            servers.forEach(function (hostname) {
                $.getJSON('/gpu_data/' + hostname, function (data) {
                    // Filter data
                    var filteredData = data.filter(gpu => {
                        var memory = parseValue(gpu.memory);
                        var utilization = parseValue(gpu.utilization);
                        return memory <= memoryFilter && utilization <= utilizationFilter;
                    });

                    // Compare with last fetched data
                    if (JSON.stringify(lastData[hostname]) !== JSON.stringify(filteredData)) {
                        // Remove existing rows for this server
                        table.rows(function (idx, data, node) {
                            return data[0] === hostname;
                        }).remove();

                        // If the server is not selected and it's not 'all' then just update the lastData without rendering
                        if (selectedServer !== 'all' && selectedServer !== hostname) {
                            lastData[hostname] = filteredData;
                            return;
                        }

                        // Add new rows
                        filteredData.forEach((gpu, index) => {
                            var row = [];
                            row.push(hostname);
                            row.push(index);
                            row.push(gpu.name);
                            row.push(gpu.temperature);
                            row.push(gpu.power);
                            row.push(gpu.memory);
                            row.push(gpu.utilization);
                            table.row.add(row);
                        });

                        table.draw();
                    }

                    // Store last fetched data
                    lastData[hostname] = filteredData;
                });
            });
        }

        // Initial table update
        updateTable();

        // Update the table every second for the selected server(s).
        setInterval(updateTable, 1000);
    </script>
</body>

</html>