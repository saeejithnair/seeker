<!DOCTYPE html>
<html>

<head>
    <title>GPU Dashboard</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <label for="server-select">Select Server</label>
                <select id="server-select" class="form-control">
                    <option value="all">All</option>
                    <!-- Server options will be dynamically populated -->
                </select>
            </div>
            <div class="col-md-3">
                <label for="memory-filter">Memory Filter (<= MiB)</label>
                        <input type="number" id="memory-filter" class="form-control" placeholder="Enter Memory">
            </div>
            <div class="col-md-3">
                <label for="utilization-filter">Utilization Filter (<= %)</label>
                        <input type="number" id="utilization-filter" class="form-control"
                            placeholder="Enter Utilization">
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary mt-4" onclick="updateTable()">Filter</button>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <h3>Launch Experiment</h3>
                <form id="experiment-form">
                    <div class="form-group">
                        <label for="experiment-server">Server</label>
                        <select id="experiment-server" class="form-control" required>
                            <!-- Server options will be dynamically populated -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="experiment-gpus">GPUs</label>
                        <select id="experiment-gpus" class="form-control" multiple required>
                            <!-- GPU options will be dynamically populated -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="experiment-project">Project</label>
                        <input type="text" id="experiment-project" class="form-control" required
                            placeholder="e.g., ~/work/project">
                    </div>
                    <div class="form-group">
                        <label for="experiment-command">Command</label>
                        <input type="text" id="experiment-command" class="form-control" required
                            placeholder="e.g., docker compose run -d --build elastic-nerf wandb agent saeejithn/elastic-nerf/bqxz2xvw">
                    </div>
                    <button type="submit" class="btn btn-primary">Launch Experiment</button>
                </form>
            </div>
        </div>

        <div id="experiment-output" class="mt-4"></div>
    </div>

    <table id="gpu-table" class="display" style="width:100%">
        <thead>
            <tr>
                <th>Server</th>
                <th>GPU</th>
                <th>Name</th>
                <th>Temp</th>
                <th>Power</th>
                <th>Memory</th>
                <th>Utilization</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        var table = $('#gpu-table').DataTable({ searching: true });
        var servers = ['banana', 'chai', 'cheetah', 'citrus', 'davincci', 'guacamole', 'kiwi', 'latte', 'lavazza', 'lilac', 'lox', 'macchiato', 'matcha', 'platypus'];
        var lastData = {};

        function parseValue(value) {
            return parseFloat(value.split(' ')[0]);
        }

        function updateTable() {
            var selectedServer = $('#server-select').val();
            var memoryFilter = Number($('#memory-filter').val()) || Infinity;
            var utilizationFilter = Number($('#utilization-filter').val()) || Infinity;

            servers.forEach(function (hostname) {
                $.getJSON('/gpu_data/' + hostname, function (data) {
                    var filteredData = data.filter(gpu => {
                        var memory = parseValue(gpu.memory);
                        var utilization = parseValue(gpu.utilization);
                        return memory <= memoryFilter && utilization <= utilizationFilter;
                    });

                    if (JSON.stringify(lastData[hostname]) !== JSON.stringify(filteredData)) {
                        table.rows(function (idx, data, node) {
                            return data[0] === hostname;
                        }).remove();

                        if (selectedServer !== 'all' && selectedServer !== hostname) {
                            lastData[hostname] = filteredData;
                            return;
                        }

                        filteredData.forEach((gpu, index) => {
                            var row = [hostname, index, gpu.name, gpu.temperature, gpu.power, gpu.memory, gpu.utilization];
                            table.row.add(row);
                        });

                        table.draw();
                    }

                    lastData[hostname] = filteredData;
                });
            });
        }

        // Populate server select options
        servers.forEach(function (server) {
            $('#server-select, #experiment-server').append($('<option>', {
                value: server,
                text: server
            }));
        });

        // Update GPU options when server is selected
        $('#experiment-server').change(function () {
            var selectedServer = $(this).val();
            $.getJSON('/gpu_data/' + selectedServer, function (data) {
                $('#experiment-gpus').empty();
                data.forEach(function (gpu, index) {
                    $('#experiment-gpus').append($('<option>', {
                        value: index,
                        text: 'GPU ' + index + ' - ' + gpu.name
                    }));
                });
            });
        });

        // Handle experiment form submission
        $('#experiment-form').submit(function (e) {
            e.preventDefault();
            var server = $('#experiment-server').val();
            var gpus = $('#experiment-gpus').val();
            var project = $('#experiment-project').val();
            var command = $('#experiment-command').val();

            $('#experiment-output').html('<div class="alert alert-info">Launching experiment...</div>');

            $.ajax({
                url: '/launch_experiment',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    hostname: server,
                    gpu_ids: gpus,
                    project: project,
                    command: command
                }),
                success: function (response) {
                    var output = '<h5>Git Pull Output:</h5><pre>' + response.pull_output + '</pre>';
                    response.results.forEach(function (result) {
                        output += '<h5>GPU ' + result.gpu_id + ' (Architecture: ' + result.architecture + ')</h5>' +
                            '<pre>Command: ' + result.command + '\n\nOutput:\n' + result.output + '</pre>';
                    });
                    $('#experiment-output').html('<div class="alert alert-success">Experiment launched successfully!</div>' + output);
                },
                error: function (xhr, status, error) {
                    $('#experiment-output').html('<div class="alert alert-danger">Error launching experiment: ' + error + '</div><pre>' + xhr.responseText + '</pre>');
                }
            });
        });

        // Initial table update
        updateTable();

        // Update the table every second
        setInterval(updateTable, 1000);
    </script>
</body>

</html>